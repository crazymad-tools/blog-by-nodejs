<!DOCTYPE html>
<html>
<head>
    <title><%= title %></title>
    <!-- <link rel='stylesheet' href='/css/style.css' /> -->
    <link rel="stylesheet" href="/css/blog.css" />
    <link rel="stylesheet" href="/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/css/bootstrap-theme.min.css">
    <link rel="stylesheet" hreg="/css/markdown.css">
    <style>
        .pagination {
            -webkit-user-select:none;
        }
        a {
            color: #17A67B;
            cursor: pointer;
        }
        body {
            background-image: url("/images/test.jpg");
            background-attachment: fixed;
            background-repeat: no-repeat;
            background-size: 100% 100%;
            margin: 0;
            padding: 0;
            position: relative;
        }
        .item-1 {
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            box-shadow: gray 0px 1px 10px;
            position: relative;
            padding: 10px;
        }
        .item-1::before {
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            content: "";
            top: 0px;
            left: 0px;
            background-color: white;
            opacity: 0.6;
            position: absolute;
            height: 100%;
            width: 100%;
            z-index: -2;
        }
        .head-div {
            background-image: url('/images/head.jpg');
            width: 100px;
            height: 100px;
            border-radius: 5px;
            box-shadow: black 0px 0px 10px;
        }
        #brief {
            position: relative;
            border-radius: 5px;
        }
        #brief::before {
            position: absolute;
            content: "";
            top: 0px;
            left: 0px;
            border-radius: 5px;
            width: 100%;
            height: 100%;
            background-color: white;
            opacity: 0.85;
            z-index: -1;
            //-webkit-filter: blur(3px);
        }
        #tick-text {
            -webkit-transform:rotate(5deg);
            position: absolute;
            top: 90px;
            left: 0px;
            padding: 40px;
            font-size: 17px;
            font-family: KaiTi;
            font-weight: 600;
        }
        .item-2 {
            width: 100%;
            padding: 5px;
            position: relative;
            border-radius: 5px;
            margin-left: 50px;
            opacity: 0;
            margin-bottom: 30px;
        }
        .item-2::before {
            content: "";
            position: absolute;
            left: 0px;
            top: 0px;
            background-color: white;
            border-radius: 5px;
            opacity: 0.85;
            height: 100%;
            width: 100%;
            z-index: -1;
        }
        img {
            max-width: 100%;
        }
        .category {
            padding: 4px 6px 4px 6px;
            margin: 5px;
            color: white;
            background-color: #454544;
            position: relative;
            font-weight: 600;
            cursor: pointer;
            border-radius: 5px;
            text-decoration: none;
            display: block;
            text-wrap: normal;
        }
        .category:hover {
            background-color: #FF6211;
            text-decoration: none;
            color: white;
            -webkit-box-shadow: 1px 1px 4px gray;
        }
        .category::before {
            content: "";
            position: absolute;
            top: 0px;
            left: -3px;
            height: 0px;
            width: 0px;
            border-left: 10px solid transparent;
            border-right: 10px solid gray;
        }
        .category-choosed {
            background-color: #0086ba;
        }
        #footer {
            //position: absolute;
            //bottom: 0;
            margin-top: 100px;
        }
    </style>
    <script src="js/jquery.js"></script>
    <script src="js/markdown.js"></script>
    <script>
        categorys = [];
        category_id = -1;
        pageindex = 0;          // 当前分页
        function getCategory() {
            $.ajax({
                url : "/list/category",
                success : function(res) {
                    var maxcount = 0;
                    categorys = res;
                    for (var i = 0; i < categorys.length; i++) {
                        maxcount += categorys[i].count;
                        categorys[i].pageCount = Math.ceil(categorys[i].count/5);
                    }
                    categorys.push({
                       count : maxcount,
                       pageCount : Math.ceil(maxcount/5)
                    });
                    console.log(categorys);
                    createCategorys();
                    createPageIndex();
                    createItems();
                }
            });
        }
        function login() {
            var account = $("#account").val();
            var password = $("#password").val();
            $.ajax({
                url: "/mysql",
                type: "post",
                data : JSON.stringify([{
                    account : account,
                    password : password
                }]),
                contentType: "application/json; charset=utf-8",
                success: function(res) {
                    if ("success" == res) {
                        alert("登录成功");
                        closeLoginModal();
                    } else if ("is login" == res) {
                        alert("当前账户已登录");
                        closeLoginModal();
                    } else {
                        alert("登录失败，账号或密码错误");
                    }
                }
            });
        }
        function showLoginModal() {
            $("#login-modal").show();
            $("#login-modal-back").show();
        }
        function closeLoginModal() {
            $("#login-modal").hide();
            $("#login-modal-back").hide();
        }
        function showItems() {
            var items = $(".item-2");
            var j = 1;
            var delayTime = 100;
            items.eq(0).animate({marginLeft: "0px", opacity: 1});
            for (var i = 1; i < items.length; i++) {
                setTimeout(function() {
                    //console.log(j);
                    items.eq(j++).animate({marginLeft: "0px", opacity: 1});
                }, delayTime+=100);
            }
        }
        function createItems(index) {
            if (index != undefined) {
                $(".category").eq(category_id+1).removeClass("category-choosed");
                category_id = index;
                $(".category").eq(category_id+1).addClass("category-choosed");
                pageindex = 0;
                createPageIndex();
            }
            $.ajax({
                url: "/list?category_id="+category_id+"&pageindex="+pageindex,
                success: function(res) {
                    console.log(res);
                    var itemBorder = $("#item-border");
                    itemBorder.html("");
                    for (var i = 0; i < res.length; i++) {
                        var md = parse(res[i].abstract, true);
                        var html = "<h4><a target='_blank' href='/show?blogid=" + res[i].blogid +  "'>" + res[i].title + "</a></h4>";
                        html += "<p style='padding-left: 10px; margin: 0px; color: gray; font-size: 10px;'>" + res[i].pdate + "</p>";
                        html = "<div class='text item-2'>" + html + md + "</div>";
                        itemBorder.append(html);
                    }
                    showItems();
                }
            })
            $("#right").css("height", $(window).height());
        }
        function createCategorys() {
            var categoryDiv = $("#category-list");
            var html = "<a class='category category-choosed' onclick='createItems(-1)'>全部博客&nbsp&nbsp&nbsp"
                        + categorys[categorys.length-1].count + "篇</a>";
            for (var i = 0; i < categorys.length-1; i++) {
                html += "<a class='category' onclick='createItems(" + i + ")'>"
                        + categorys[i].name + "&nbsp&nbsp&nbsp" + categorys[i].count + "篇</a>";
            }
            categoryDiv.append(html);
        }
        function createPageIndex() {
            if (category_id == -1) {
                var pageCount = categorys[categorys.length-1].pageCount;
            } else {
                var pageCount = categorys[category_id].pageCount;
            }
            var html = "<li><a onclick='changePage(\"left\")'>&laquo;</a></li>";
            for (var i = 0; i < pageCount; i++) {
                if (i == 0)
                    html += "<li class='active'><a onclick='changePage(" + i + ")'>" + (i+1) + "</a></li>";
                else
                    html += "<li><a onclick='changePage(" + i + ")'>" + (i+1) + "</a></li>";
            }
            html += "<li><a onclick='changePage(\"right\")'>&raquo;</a></li>";
            $("#page-index-top").html(html);
            $("#page-index-bottom").html(html);
        }
        function changePage(index) {
            var id = category_id == -1 ? categorys.length-1 : category_id;
            if (index == pageindex || index < 0) return;
            else if (index == "left" && pageindex > 0) index = pageindex - 1;
            else if (index == "right" && pageindex < categorys[id].pageCount-1) index = pageindex + 1;
            else if (typeof index == "string") return;
            var pageIndexTopList = $("#page-index-top").find("li");
            var pageIndexBottomList = $("#page-index-bottom").find("li");
            pageIndexTopList.eq(pageindex+1).removeClass("active");
            pageIndexBottomList.eq(pageindex+1).removeClass("active");
            pageindex = index;
            pageIndexTopList.eq(pageindex+1).addClass("active");
            pageIndexBottomList.eq(pageindex+1).addClass("active");
            $('html, body').animate({ scrollTop: 0 }, 'fast');
            createItems();
        }
        $(function() {
            console.log(category_id);
            getCategory();
        })
    </script>
</head>
<body>
<div style="text-align: center; padding: 5px; padding-bottom: 10px; background-color: black;">
    <a style="text-decoration: none;" id="index-title" onclick="showLoginModal()">
        <h1 style="font-family: Arial; color: #E0E0E0; font-weight: 900; margin: 0px;">CRAZY_MAD'S BLOG</h1>
    </a>
</div>
<div class="container-fluid" style="height: 100%; width: 100%;">
    <div class="row">
        <div class="col-xs-3" style="">
            <div class="item-1" style="" id="category-list">
            </div>
        </div>
        <div class="col-xs-6" style="">
            <div class="item-1" style="">
                <ul class="pagination" id="page-index-top" style="margin: 0;">
                </ul>
                <div id="item-border"></div>
                <ul class="pagination" id="page-index-bottom" style="margin: 0;">
                </ul>
            </div>
        </div>
        <div class="col-xs-3" style="" id="right">
            <div class="item-1" style="">
                <div style="text-align: center;">
                    <div class="head-div" style="margin: auto;"></div>
                    <div id="brief" style="padding: 10px; margin-top: 10px;">
                        <h3 style="margin: 0px; margin-top: 10px;">CRAZY_MAD</h3>
                        就学于东南沿海某抠脚二本大学<br />
                        C++/C,JAVA,JS,PYTHON,PHP,C#...<br/ >
                        都不精通&nbsp;&nbsp;_(:3 」∠)_
                    </div>
                </div>
                <div style="position: relative">
                    <img src="/images/tick.png" style="width: 100%; position: absolute; top: 0px; left: 0px;"/>
                    <div id="tick-text">
                        学习是为了啥，还不是为了吃喝玩乐？
                        <div style="text-align: right">
                            —— CRAZY_MAD
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="footer" style="padding-top: 10px; text-align: center; background-color: #383733; height: 80px; width: 100%;">
    <p style="color: #BAB7AA; font-weight: 600;">
    Copyright &copy; 2016-2017 by crazymad<br/>
    mail: crazy_mad01@163.com or 2116913961@qq.com<br/>
    NBUT CS-154
    </p>
</div>
<div id="login-modal" class="c_modal">
    <h2 style="text-align: center; font-weight: bold; color: #38B2B2; text-shadow: 0px 0px 1px #38B2B2;">登录</h2>
    <hr style="margin-top: 10px; margin-bottom: 10px; background-color: #464646;"/>
    <div style="padding: 10px 30px 10px 30px; margin-top: 50px;" class="input-group">
        <span class="input-group-addon">账号</span>
        <input type="text" class="form-control" id="account"/>
    </div>
    <div style="padding: 10px 30px 10px 30px;" class="input-group">
        <span class="input-group-addon">密码</span>
        <input type="password" class="form-control" id="password"/>
    </div>
    <div style="padding: 10px 30px 10px 30px; float: right;" class="input-group">
        <input type="submit" class="btn btn-primary" value="提交" onclick="login()">&nbsp;
        <input type="submit" class="btn btn-default" value="取消" onclick="closeLoginModal()">
    </div>
    <div style="clear: both;"></div>
    <a target="blank" href="/register" style="margin-left: 30px;">没有账号，可以注册一个试试</a>
</div>
<div id="login-modal-back" class="c_modal_back" onclick="closeLoginModal()">
</div>
</body>
</html>
